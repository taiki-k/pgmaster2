{#
  Copyright (C) 2020-2023 Kondo Taiki

  This file is part of "pgmaster2".

  "pgmaster2" is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  "pgmaster2" is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with "pgmaster2".  If not, see <http://www.gnu.org/licenses/>.

#}{% extends "frame.html.jinja2" %}
{% block title %} {{ project }} - {{ branch }} - {{ commit.sid }}{% endblock %}
{% block extra_css%}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/stackoverflow-light.min.css" integrity="sha512-RDtnAhiPytLVV3AwzHkGVMVI4szjtSjxxyhDaH3gqdHPIw5qwQld1MVGuMu1EYoof+CaEccrO3zUVb13hQFU/A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock%}
{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js" integrity="sha512-odNmoc1XJy5x1TMVMdC7EMs3IVdItLPlCeL5vSUPN2llYKMJ2eByTTAIiiuqLg+GdNr9hF6z81p27DArRFKT7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js" integrity="sha512-bgHRAiTjGrzHzLyKOnpFvaEpGzJet3z4tZnXGjpsCcqOnAH6VGUx9frc5bcIhKTVLEiCO6vEhNAgx5jtLUYrfA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="{{ url_for('static', filename='highlightjs-vue.min.js') }}"></script>
{% endblock %}
{% block toolbar_title %} Investigate: {{ commit.sid }}{% endblock %}
{% block main_contents %}
        <v-row v-once>
          <v-col
            cols="3"
          >
            <v-menu
              offset-y
{% if not urls.parents %}
              disabled
{% endif %}
            >
              <template v-slot:activator="{ on, attrs }">
                <v-btn
                  v-bind="attrs"
                  v-on="on"
                  color="secondary"
{% if not urls.parents %}
                  disabled
{% endif %}
                >
                  <v-icon>mdi-page-previous-outline</v-icon>
                  Parent
                </v-btn>
              </template>
              <v-list>
{% if urls.parents %}{% for parent in urls.parents %}
                <v-list-item
                  href="{{ url_for('investigate', project = project, branch = branch, commitid = parent.id) }}"
                >
                  <v-icon>mdi-source-merge</v-icon>
                  <v-list-title>{{ parent.sid }}</v-list-title>
                </v-list-item>
{% endfor %}{% endif %}
              </v-list>
            </v-menu>
            <v-menu
              offset-y
{% if not urls.children %}
              disabled
{% endif %}
            >
              <template v-slot:activator="{ on, attrs }">
                <v-btn
                  v-bind="attrs"
                  v-on="on"
                  color="secondary"
{% if not urls.children %}
                  disabled
{% endif %}
                >
                  <v-icon>mdi-page-next-outline</v-icon>
                  Child
                </v-btn>
              </template>
              <v-list>
{% if urls.children %}{% for child in urls.children %}
                <v-list-item
                  href="{{ url_for('investigate', project = project, branch = branch, commitid = child.id) }}"
                >
                  <v-icon>mdi-source-fork</v-icon>
                  <v-list-title>{{ child.sid }}</v-list-title>
                </v-list-item>
{% endfor %}{% endif %}
              </v-list>
            </v-menu>
          </v-col>
          <v-col
            cols="2"
          >
            <v-btn
              color="primary"
              dark
{% if urls.repo_browser %}
              href="{{ urls.repo_browser }}"
{% else %}
              disabled
{% endif %}
            >
              <v-icon>mdi-file-link</v-icon>
              View Files
            </v-btn>
          </v-col>
          <v-col
            cols="7"
          >
            <!-- Padding -->
          </v-col>
        </v-row>
        <v-row v-once>
          <v-col
            cols="6"
          >
{% if commit.initial %}
             <v-alert
              dense
              elevation="10"
              prominent
              type="warning"
            >
              Since this is the initial commit, the diff is worthless.<br />
              Please look at the files directly in {% if urls.repo_browser %}<a href="{{ urls.repo_browser }}">{% endif %}the repository browser{% if urls.repo_browser %}</a>{% endif %}.
            </v-alert>
{% else %}
            <!-- Padding -->
{% endif %}
          </v-col>
          <v-col
            cols="6"
          >
            <v-card
              outlined
            >
              <v-list-item two-line>
                <v-list-item-content>
                  <v-list-item-title>Last updated</v-list-item-title>
                  <v-list-item-subtitle>{{ commit.updated }}</v-list-item-subtitle>
                </v-list-item-content>
              </v-list-item>
            </v-card>
          </v-col>
        </v-row>
        <v-form
          ref="invest"
          v-mode="formValid"
          @submit.prevent="modify"
        >
          <v-row v-once>
            <v-col
              cols="6"
            >
              <v-card
                outlined
                elevation="4"
                class="overflow-y-auto"
                style="height: 108px"
              >
                <v-card-title
                  class="title text--primary"
                >
                  {{ commit.summary }}
                </v-card-title>
              </v-card>
            </v-col>
            <v-col
              cols="6"
            >
              <v-textarea
                v-model="investSNote"
                label="Short note (Title)"
                height="108"
                outlined
                clearable
                required
              >
              </v-textarea>
            </v-col>
          </v-row>
          <v-row v-once>
            <v-col
              cols="6"
            >
              <v-card
                outlined
                elevation="4"
              >
                <v-list-item two-line>
                  <v-list-item-content>
                    <v-list-item-title>Author</v-list-item-title>
                    <v-list-item-subtitle>{{ commit.author }}</v-list-item-subtitle>
                  </v-list-item-content>
                </v-list-item>
                <v-list-item two-line>
                  <v-list-item-content>
                    <v-list-item-title>Commit Date</v-list-item-title>
                    <v-list-item-subtitle>{{ commit.date }} {% if commit.tz >= 0 %}+{% endif %}{{ commit.tz }}</v-list-item-subtitle>
                  </v-list-item-content>
                </v-list-item>
              </v-card>
            </v-col>
            <v-col
              cols="6"
            >
              <!-- Padding -->
            </v-col>
          </v-row>
          <v-row v-once>
            <v-col
              cols="6"
            >
              <v-card
                outlined
                elevation="4"
                class="overflow-y-auto"
                style="height: 600px"
              >
                <v-card-text>
                  <p v-pre>{{ commit.message }}
                  </p>
                </v-card-text>
              </v-card>
            </v-col>
            <v-col
              cols="6"
            >
              <v-textarea
                v-model="investNote"
                label="Note"
                height="600"
                required
                clearable
                outlined
              >
              </v-textarea>
            </v-col>
          </v-row>
          <v-row v-once>
            <v-col
              cols="6"
            >
              <v-container
                class="overflow-x-auto overflow-y-auto"
                style="height: 600px;"
              >
                <v-row
                  v-for="(code_diff,i) in diffs"
                  :key="i"
                  dense
                >
                  <v-col>
                    <highlightjs language="diff" :code="code_diff" style="overflow-x: visible" />
                  </v-col>
                </v-row>
              </v-container>
            </v-col>
            <v-col
              cols="6"
            >
              <v-textarea
                v-model="investAnalysis"
                label="Code Analysis"
                height="600"
                required
                clearable
                outlined
              >
              </v-textarea>
            </v-col>
          </v-row>
          <v-row v-once>
            <v-col
              cols="6"
            >
              <!-- Padding -->
            </v-col>
            <v-col
              cols="6"
            >
              <v-combobox
                v-model="investKeywords"
                :items="kwd_items"
                label="Keywords"
                ref="kwdComboBox"
                outlined
                clearable
                multiple
                chips
              >
              </v-combobox>
            </v-col>
          </v-row>
          <v-row>
            <v-col
              cols="6"
              v-once
            >
              <!-- Padding -->
            </v-col>
            <v-col
              cols="1"
              v-once
            >
              <v-btn
                href="{{ url_for('search_backpatch', project = project, branch = branch, commitid = commit.id) }}"
              >
                <v-icon>mdi-magnify</v-icon>
                Search Back-patch
              </v-btn>
            </v-col>
            <v-col
              cols="4"
              v-once
            >
              <!-- Padding -->
            </v-col>
            <v-col
              cols="1"
            >
              <v-btn
                :color="btnColor"
                dark
                @click="modify"
                :loading="btnLoading"
              >
                <v-icon>mdi-send</v-icon>
                Submit
              </v-btn>
            </v-col>
          </v-row>
        </v-form>
{% endblock %}

{% block vue_plugins %}
  Vue.use(hljsVuePlugin);
{% endblock %}

{% block navi_items %}
        {
          text: "{{ project }}",
          disabled: false,
          href: "{{ url_for('project', project = project) }}"
        },
        {
          text: "{{ branch }}",
          disabled: false,
          href: "{{ url_for('branch', project = project, branch = branch) }}"
        },
        {
          text: "{{ commit.sid }}",
          disabled: true,
          href: "#"
        },
{% endblock %}

{% block extra_data %}
      formValid: true,
      diffs: [
{% for diff in commit.diffs %}        "{{ diff }}",
{% endfor %}      ],
      btnColor: 'primary',
      btnLoading: false,
      investSNote: "{{ commit.snote }}",
      investNote: "{{ commit.note }}",
      investAnalysis: "{{ commit.analysis }}",
      investKeywords: {{ commit.keywords }},
      kwd_items: {{ keywords }},
{% endblock %}

{% block vue_methods %}
      modify: async function() {
        this.$refs.kwdComboBox.blur();
        this.$nextTick(async () => {
          send_data = {
            snote: this.investSNote,
            note: this.investNote,
            analysis: this.investAnalysis,
            keywords: this.investKeywords
          };

          this.btnLoading = true;
          try {
            res = await axios.post(
              "{{ url_for('webapi_v1.investigate_modify', project = project, branch = branch, commitid = commit.id) }}",
              send_data
            );
            this.btnColor = 'primary';
          }
          catch (error) {
            this.btnColor = 'error';
          }
          finally {
            this.btnLoading = false;
          }
        });
      }
{% endblock %}
